<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>نموذج التفتيش على المواقع</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0f1a33;
      --card:#ffffff; --ink:#0b1220;
      --line:#e6e8ee;
      --accent:#2563eb; --accent2:#1d4ed8;
      --ok:#16a34a; --warn:#b45309;

      --noteText:#7c2d12;
      --noteBg:#fffbeb;
      --noteBorder:#f59e0b;

      --shadow: rgbal: rgba(2,6,23,.18);
      --shadow: rgba(2,6,23,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Tahoma,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(22,163,74,.18), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:18px;
    }
    .wrap{max-width:1024px;margin:0 auto}
    .hero{color:#fff;margin:6px 0 14px}
    .hero h1{margin:0;font-size:24px;letter-spacing:.2px}

    .card{
      background:var(--card);
      border-radius:18px;
      box-shadow:0 18px 45px var(--shadow);
      overflow:hidden;
    }
    .topbar{
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(37,99,235,.10), rgba(22,163,74,.08));
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .gate{
      font-size:13px;
      font-weight:950;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#fff;
    }
    .gate.bad{color:var(--warn);background:#fff7ed;border-color:#fed7aa}
    .gate.good{color:var(--ok);background:#dcfce7;border-color:#bbf7d0}

    .content{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr 1fr}}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}
    label{font-size:13px;font-weight:900;color:#111827}
    input,select,textarea{
      width:100%;
      padding:12px;
      margin-top:6px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:15px;
      background:#fff;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .hint{margin-top:6px;font-size:12px;color:#64748b;line-height:1.5}

    .actions{
      padding:0 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      border:0;
      border-radius:12px;
      padding:12px 16px;
      font-weight:950;
      font-size:15px;
      cursor:pointer;
      touch-action:manipulation;
    }
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{background:var(--accent2)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .btn-ghost{background:#eef2ff;color:#111827}

    .tablewrap{
      margin:0 16px 16px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:auto;
    }
    table{width:100%;border-collapse:collapse;min-width:940px}
    th,td{border-bottom:1px solid var(--line);padding:12px 10px;font-size:14px;vertical-align:top}
    th{background:#f8fafc;font-weight:950;text-align:center}

    .check{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-weight:950;
      background:#fff;
    }

    textarea.has-note{
      background:var(--noteBg);
      border-color:var(--noteBorder);
      color:var(--noteText);
      font-weight:750;
    }
    .note-flag{
      margin-top:6px;
      font-size:12px;
      font-weight:950;
      color:var(--noteBorder);
      display:none;
    }
    textarea.auto-note{color:#555;font-style:italic;}

    /* PDF */
    .print-header{display:none}
    .no-print{ /* used for print */ }
    @media print{
      body{background:#fff !important;padding:0 !important;}
      .no-print{display:none !important;}
      .card{box-shadow:none !important;border-radius:0 !important;}
      .tablewrap{margin:0;border:1px solid #ddd;border-radius:0}
      table{min-width:0}
      th,td{font-size:12px}
      input,select,textarea{border:0 !important; padding:0 !important; box-shadow:none !important; background:transparent !important;}
      textarea.has-note{
        background:#fff3cd !important;
        border:1px solid #f59e0b !important;
        padding:6px !important;
      }
      .print-header{
        display:block !important;
        padding:12px;
        border-bottom:1px solid #ddd;
      }
      .print-title{margin:0 0 6px;font-size:16px;font-weight:950}
      .print-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;font-size:12px}
      .kv{display:flex;gap:6px;align-items:baseline}
      .k{color:#555;font-weight:900}
      .v{color:#111}
    }
  
/* ====== PDF Typography & Layout Enhancement ====== */
@media print {
  @page { size: A4; margin: 12mm; }

  html, body{
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    font-family: "Tahoma","Arial",sans-serif !important;
    font-size: 12px !important;
    line-height: 1.45 !important;
  }

  /* توازن النص العربي */
  *{
    direction: rtl !important;
    unicode-bidi: plaintext !important;
  }

  h1,h2,h3{
    line-height:1.2 !important;
    margin:0 0 8px 0 !important;
  }

  /* جدول PDF مضبوط */
  table{
    width:100% !important;
    table-layout: fixed !important;
  }
  th, td{
    padding:8px 10px !important;
    vertical-align: middle !important;
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
  }

  /* محاذاة الأعمدة */
  th, td{ text-align: right !important; }

  /* حقول الإدخال تظهر كنص مرتب */
  input, textarea, select{
    font-size:12px !important;
    line-height:1.4 !important;
    padding:6px 8px !important;
  }

  /* صناديق الملاحظات إن وجدت */
  .badge-note, .note-box, .note, .alert-note{
    font-size:11px !important;
    line-height:1.35 !important;
  }

  /* خفف أي تأثيرات شفافية */
  [style*="opacity"]{ opacity: 1 !important; }
}


/* ====== PDF Checkbox Normalization ====== */
@media print {
  input[type="checkbox"]{
    appearance: none !important;
    -webkit-appearance: none !important;
    width: 14px !important;
    height: 14px !important;
    border: 1.5px solid #000 !important;
    border-radius: 3px !important;
    position: relative !important;
  }
  input[type="checkbox"]:checked::after{
    content: "✔" !important;
    position: absolute !important;
    top: -2px !important;
    left: 1px !important;
    font-size: 14px !important;
    color: #000 !important;
    font-weight: bold !important;
  }
}


/* ====== PDF Notes (full text + orange highlight) ====== */
.note-print{ display:none; }
@media print{
  /* اخفاء أي تنبيه نصي مثل "يوجد ملاحظة" إن وجد */
  .note-flag, .note-warning, .warn-note, .note-hint{ display:none !important; }

  /* اخفاء خانة الإدخال واظهار النص الكامل */
  textarea[id^="note_"], input[id^="note_"]{ display:none !important; }

  .note-print{
    display:block !important;
    white-space: pre-wrap !important;
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
    line-height: 1.55 !important;
    color:#000 !important;
    background:#fff !important;
    border: 1.5px solid #000 !important;
    border-radius: 8px !important;
    padding: 7px 10px !important;
    min-height: 22px !important;
  }

  /* إذا يوجد ملاحظة: تمييز برتقالي */
  .note-print.has-note{
    border-color:#f97316 !important;
    background:#fff7ed !important;
  }

  /* خلي خلية الصف تتمدد طبيعي */
  td{ height:auto !important; }
}

</style>
</head>
<body>
<div class="wrap">
  <div class="hero no-print">
    <h1>نموذج التفتيش على المواقع</h1>
  </div>

  <div class="card">
    <div class="topbar no-print">
      <div class="gate bad" id="gate">⛔ يلزم تأكيد جميع المواقع قبل التصدير</div>
      <div class="gate" id="empStatus">—</div>
    </div>

    <!-- PDF header only -->
    <div class="print-header">
      <div class="print-title">نموذج التفتيش على المواقع</div>
      <div class="print-grid" id="printGrid"></div>
    </div>

    <div class="content no-print">
      <div class="grid">
        <div>
          <label>الرقم الوظيفي</label>
          <input id="empNo" inputmode="numeric" placeholder="اكتب الرقم الوظيفي" />
<div class="hint">عند إدخال رقم موجود سيتم تعبئة الاسم والوردية تلقائيًا.</div>
        </div>

        <div>
          <label>الاسم</label>
          <input id="guardName" placeholder="سيتم تعبئته عند جلب الاسم" />
          <div class="hint">يمكنك التعديل يدويًا إذا لزم.</div>
        </div>

        <div>
          <label>الوردية</label>
          <select id="shift">
            <option value="">اختر</option><option>أ</option><option>ب</option><option>ج</option><option>د</option>
          </select>
        </div>

        <div>
          <label>التاريخ</label>
          <input id="date" type="date" readonly />
          <div class="hint">يتم تعبئته تلقائيًا.</div>
        </div>
        <div>
          <label>الوقت</label>
          <input id="time" type="time" readonly />
          <div class="hint">يتم تعبئته تلقائيًا.</div>
        </div>
      </div>
    </div>

    <div class="actions no-print">
      <button class="btn-primary" id="pdfBtn" disabled>تصدير PDF</button>
      <button class="btn-ghost" id="clearBtn" type="button">مسح</button>
    </div>

    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>الموقع</th>
            <th>الأنظمة</th>
            <th>تم</th>
            <th>ملاحظات</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ==== قاعدة بيانات الموظفين (مدمجة) ====
    const empDB = {
    "95175": { name: "سلطان محمد القحطاني", shift: "أ" },
    "95052": { name: "بدر مسفر الاحمرب", shift: "ب" },
    "81540": { name: "سعيد مبارك السعيد", shift: "ج" },
    "106007": { name: "ناصر مبارك السبيعي", shift: "د" },
    "84642": { name: "ابراهيم محمد ال صفيان", shift: "د" }
  };

  // ==== بيانات المواقع ====
  const sites = [
    { site:"مبنى A الدور الخامس والأرضي والمواقف – LG – B", systems:"الأبواب + اكسس الأبواب" },
    { site:"مبنى B الدور الخامس والأرضي والمواقف – LG – B", systems:"الأبواب + اكسس الأبواب" },
    { site:"مبنى C الدور الأرضي والمواقف – LG – B", systems:"الأبواب + اكسس الأبواب" },
    { site:"مبنى الخدمات مقابل برج B", systems:"الأبواب والتخزين" },
    { site:"مبنى الخدمات امام مبنى D", systems:"الأبواب + اكسس الأبواب" },
    { site:"الأعمدة الخارجية + المصدات البلاستيكية للمواقف الخارجية.", systems:"إغلاق أعمدة الدخول والمصدات البلاستيكية" }
  ];

  const rowsEl = document.getElementById("rows");
  const pdfBtn = document.getElementById("pdfBtn");
  const gate = document.getElementById("gate");
  const empStatus = document.getElementById("empStatus");

  const empNoEl = document.getElementById("empNo");
  const nameEl  = document.getElementById("guardName");

  
  function pad2(n){ return String(n).padStart(2,"0"); }

  function setNowDateTime(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = pad2(now.getMonth()+1);
    const dd = pad2(now.getDate());
    const hh = pad2(now.getHours());
    const mi = pad2(now.getMinutes());
    const dateEl = document.getElementById("date");
    const timeEl = document.getElementById("time");
    if(dateEl) dateEl.value = `${yyyy}-${mm}-${dd}`;
    if(timeEl) timeEl.value = `${hh}:${mi}`;
  }

  function normalizeEmpNo(s){
    const map = {"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};
    let t = String(s||"").trim().replace(/[٠-٩]/g, d => map[d] || d);
    t = t.replace(/[^0-9]/g, "");
    return t;
  }

  function autoLookup(){
    const no = normalizeEmpNo(empNoEl.value);
    empNoEl.value = no;
    if(empDB[no]){
      nameEl.value = empDB[no].name;
      document.getElementById("shift").value = empDB[no].shift;
    }
    updateEmpStatus();
    setNowDateTime();
  }

  function updateEmpStatus(){
    const no = normalizeEmpNo(empNoEl.value);
    if(!no){
      empStatus.textContent = "—";
      empStatus.className = "gate";
      return;
    }
    if(empDB[no]){
      empStatus.textContent = "✅ تم التعرف على الموظف";
      empStatus.className = "gate good";
    }else{
      empStatus.textContent = "ℹ️ رقم غير موجود";
      empStatus.className = "gate bad";
    }
  }

  function fetchName(){
    const no = normalizeEmpNo(empNoEl.value);
    empNoEl.value = no;
    if(empDB[no]){
      nameEl.value = empDB[no];
      updateEmpStatus();
      return true;
    }
    updateEmpStatus();
    alert("الرقم غير موجود في القائمة");
    return false;
  }

  function renderSites(){
    rowsEl.innerHTML="";
    sites.forEach((r,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.site)}</td>
        <td>${escapeHtml(r.systems)}</td>
        <td style="text-align:center">
          <label class="check"><input type="checkbox" id="chk_${i}"> تم</label>
        </td>
        <td>
          <textarea id="note_${i}" placeholder="لا يوجد ملاحظات"></textarea>
          <div class="note-flag" id="flag_${i}">⚠ يوجد ملاحظة</div>
        </td>
      `;
      rowsEl.appendChild(tr);

      document.getElementById("chk_"+i).addEventListener("change", refreshGate);
      document.getElementById("note_"+i).addEventListener("input", ()=>noteCheck(i));
    });
  }

  function noteCheck(i){
    const n=document.getElementById("note_"+i);
    const f=document.getElementById("flag_"+i);
    if(n.value.trim()){
      n.classList.add("has-note");
      n.classList.remove("auto-note");
      f.style.display="block";
    }else{
      n.classList.remove("has-note","auto-note");
      f.style.display="none";
    }
  }

  function allChecked(){
    return sites.every((_,i)=>document.getElementById("chk_"+i).checked);
  }

  function refreshGate(){
    const ok = allChecked();
    pdfBtn.disabled = !ok;
    if(ok){
      gate.textContent="✅ تم تأكيد جميع المواقع — جاهز للتصدير";
      gate.className="gate good";
    }else{
      gate.textContent="⛔ يلزم تأكيد جميع المواقع قبل التصدير";
      gate.className="gate bad";
    }
  }

  function buildPrintHeader(){
    const guardName = nameEl.value || "—";
    const empNo = empNoEl.value || "—";
    const shift = document.getElementById("shift").value || "—";
    const date  = document.getElementById("date").value || "—";
    const time  = document.getElementById("time").value || "—";

    document.getElementById("printGrid").innerHTML = `
      <div class="kv"><span class="k">الاسم:</span><span class="v">${escapeHtml(guardName)}</span></div>
      <div class="kv"><span class="k">الرقم الوظيفي:</span><span class="v">${escapeHtml(empNo)}</span></div>
      <div class="kv"><span class="k">الوردية:</span><span class="v">${escapeHtml(shift)}</span></div>
      <div class="kv"><span class="k">التاريخ:</span><span class="v">${escapeHtml(date)}</span></div>
      <div class="kv"><span class="k">الوقت:</span><span class="v">${escapeHtml(time)}</span></div>
    `;
  }

  function exportPDF(){
    if(!allChecked()) return;

    // املأ الملاحظات الفارغة قبل الطباعة
    sites.forEach((_,i)=>{
      const n=document.getElementById("note_"+i);
      if(!n.value.trim()){
        n.value="لا يوجد ملاحظات";
        n.classList.add("auto-note");
      }
    });

    buildPrintHeader();
    window.print();
  }

  function clearAll(){
    empNoEl.value="";
    nameEl.value="";
    document.getElementById("shift").value="";
    /* تاريخ تلقائي */
    sites.forEach((_,i)=>{
      const chk=document.getElementById("chk_"+i);
      const note=document.getElementById("note_"+i);
      const flag=document.getElementById("flag_"+i);
      if(chk) chk.checked=false;
      if(note){ note.value=""; note.classList.remove("has-note","auto-note"); }
      if(flag) flag.style.display="none";
    });
    refreshGate();
    updateEmpStatus();
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // events
  empNoEl.addEventListener("input", updateEmpStatus);
  empNoEl.addEventListener("change", autoLookup);
  empNoEl.addEventListener("blur", autoLookup);
  empNoEl.addEventListener("keyup", (e)=>{ if(e.key==="Enter") autoLookup(); });
document.getElementById("pdfBtn").addEventListener("click", exportPDF);
  document.getElementById("clearBtn").addEventListener("click", clearAll);

  // init
  renderSites();
  refreshGate();
  setNowDateTime();
  updateEmpStatus();
  setInterval(setNowDateTime, 30000);

  // ===== PDF Notes: show full note text in print as expandable box =====
  function syncNotesForPrint(){
    const noteInputs = Array.from(document.querySelectorAll('textarea[id^="note_"], input[id^="note_"]'));
    noteInputs.forEach(inp=>{
      let box = inp.parentElement.querySelector('.note-print');
      if(!box){
        box = document.createElement('div');
        box.className = 'note-print';
        inp.parentElement.appendChild(box);
      }
      const val = (inp.value || '').trim();
      if(val && val !== "لا يوجد ملاحظات"){
        box.textContent = val;
        box.classList.add("has-note");
      }else{
        box.textContent = "لا يوجد ملاحظات";
        box.classList.remove("has-note");
      }
    });
  }

  window.addEventListener("beforeprint", syncNotesForPrint);

  // ضمان التحديث عند الضغط على زر التصدير
  if(typeof exportPDF === "function"){
    const _exportPDF = exportPDF;
    exportPDF = function(){
      syncNotesForPrint();
      return _exportPDF();
    }
  }
</script>
</body>
</html>
